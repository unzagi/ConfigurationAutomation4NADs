# Configuration Automation Readme Simon Brooks

Requirements
------------
Python 3 for Window
Install jinja2 for python
Excel Spreadsheet of NADs templates

Assumptions
-----------

Basic working knowledge of Python

Process
-------

1. Find the old NADS configuration file that is being converted and copy it to the clipboard.
2. Open up template.jinja2 into a text editor

This template pulls through information based on some variables and just give an idea of when it was generated by, who generated it, what template is was based on and any other information pulled from the template spreadsheet.

    # < ------------ Start of Information Only - Do not apply  ------------>

	# {{hardware_make}} Template]
	# Template Generated
	# From jinja2 file: {{jinja2_template_name}}
	# On: {{date_time}}
	# By: {{engineer_name}}

	# For Device: {{hardware_model}}
	# Template name: {{template_name}}
	# Template has superseded: {{previous_template_name}}

	# Template specific information
	# Telco: {{telco_name}}
	# Circuit Name: {{circuit_name}}
	# Bandwidth: {{bandwidth}}
	# Routing Protocol: {{routing}}
	# Connection Type: {{connection_type}}
	# Number of Customer LANs Supported: {{customer_lans}}
	# Number of Static Routes supported: {{customer_static_routes}}
	# Out of Scope Configuration: {{out_of_scope}}

	# < ------------ End of Information Only - Do not apply  ------------>

	# < ------------ configuration start ------------>

	# Paste your configuration here, then set the variables based on jinja_variables_template and any additional one add to sed file.

	# < ------------ configuration end ------------>

3. Paste in the NADS config over the top of  where it says "# Paste your configuration here, then set the variables based on jinja_variables_template and any additional one add to sed file."

2. TA the NADS configuration file for any changes that need to be made.

For e.g. The SRX300 Devices no longer require a SFP card to be added. So the WAN interface variables can be set to ether Ge-0/0/6 or Ge-0/0/07. 
Therefore for this specific part of the configuration, I can turn the Ge-0/0/0 part of my config to a jinja2 variable so if we suddenly decide we don't want to use Ge-0/0/7 anymore it can be changed.

	# < ------------ configuration start ------------>
	# WAN IP Interfaces
	set interfaces {{ iface_wan_name }} vlan-tagging
	set interfaces {{ iface_wan_name }} description "WAN"
	set interfaces {{ iface_wan_name }} mtu 1518
	set interfaces {{ iface_wan_name }} vlan-tagging
	set interfaces {{ iface_wan_name }} description "WAN"
	set interfaces {{ iface_wan_name }} unit [PRI_WAN_VLAN] vlan-id [PRI_WAN_VLAN] description "msr1.th1 via TalkTalk - [CIRCUIT_REF]"
	set interfaces {{ iface_wan_name }} unit [PRI_WAN_VLAN] vlan-id [PRI_WAN_VLAN] family inet address [PRI_WAN_IP]/31
	set interfaces {{ iface_wan_name }} unit [SEC_WAN_VLAN] vlan-id [SEC_WAN_VLAN] description "msr2.tc1 via TalkTalk - [CIRCUIT_REF]"
	set interfaces {{ iface_wan_name }} unit [SEC_WAN_VLAN] vlan-id [SEC_WAN_VLAN] family inet address [SEC_WAN_IP]/31
	# < ------------ configuration end ------------>

4. Save this config as a .jinja2 file - with the naming convention of ##.jinja2 - where ## represents the NADS project template i.e. JU01.jinja2

5. Next a variable python config file will need to be created. I've created a python template file which looks like:
```python
# Import python time module
import time

# Variables Template
# Set the template specific description variables
hardwareMake = 'Juniper'
hardwareModel = 'Juniper SRX300'
projectTemplateName = 'template'
previousTemplateName = 'none'

#Router Template information
telcoName = 'Telco Name'
circuitName = 'Circuit Name'
bandwidth = 'bandwidth'
routing = 'routng protocol'
connectionType = 'Connection Type'
customerLans = 1
customerStaticRoutes = 0
outOfScope = "out of scope items"

#Generated File information
outputFileName = "template.txt"
jinja2TemplateName = 'template.jinja2'
dateNow = time.strftime("%c") # set the time/date
engineerName = 'Simon Brooks'

#Set the configuration file variables - use 'lowercase' and '_' for Jijna2 Variables
#These will be subject to change/additions based on the template
ifaceLanName = 'ge-0/0/0'
ifaceWanName = 'ge-0/0/7'
```

Informational Variables
-----------------------

There are informaional variables to be set:

A. the template specific variables set the type of hardware and also the old NADs template name and new NADS template name
B. The router template information all comes from the excel spreadsheet containing all the existing NADS templates
C. The generated file information needs to be set to the 
	i. What name you give the output text file e.g. template.txt or JU03-template.txt where JU03 = NADS template number
	ii. What name you give the jinja2 file e.g. template.jinja2 or JU03.jinja2 where JU03 = NADS template number
	iii. Leave dateNow variable as this generates the current time/date
	iv. The engineer name who has created the template

Configuration Variables
-----------------------

The configuration variables need to match what has been defined in the jinja2 file. At the moment I've only set ifaceLanName and ifaceWanName. 
This is mainly due to the fact I'm using automation to generate NADS templates. In future this process would be changed dramatically.

For example, if you wanted to automate the hostname you could change the static jinja2 template by doing the following:

jinja2 template 

Take your normal NADs configuration:

# Hostname
set system host-name [HOSTNAME]

Change the configuration to:

# Hostname
set system host-name {{ hostname }}

Jinja2 templates requre two sets of curly brackets, and a varable name. For nice tidy variables I am using all lowercase with underscores if there are multiple words.

For my configuration variables, I would then need to define the values for hostname

hostname = 'csr01.id00000.cpe.ifl.net'


6. The template generation python file

I've created a template file to create the configurations. This can almost certainly be improved, but since this is only being used to generate NADS configs we're sticking to a jinja2, python variables file and a router template
generation file to generate the configs.


This is the configuration file, written in python and commented.

To run this script the jinja2 module must be installed. It's written in python 3.

The bits that need to change when running this file on a new configuration file are:

a. "from jinja_variables_template import * - this must be changed to your variables file e.g. jinja_ju03_variables. This line imports the variables directly into the main python file. 

b. You MUST set the template name in the python configuration file to the jinja file you have created previously. Remember it looks for the file within the directory you are working in, so you need to make sure your jinja2 template 
exists in the same directory as the running python script. This is the same for the varables python file.

#Render the template based on jinja2 file name variable
template = jenv.get_template('template.jinja2')

c. output = tempate.render(longassline...) - so in here you list all of the i.jinja2 variables listed in the jinja2 template file, followed by the python variables we've listed in the python file. Remember, if you have 
created new variables you need to add them into here so they are automatically generated. The formatting rule I've set by here is - jinja2 variables are lowercase with underscores, and python variables are camel case.

d. The last bit of code at the end doesnt need to change, but this basically states that if the text file already exists, dont output the file to text. I've chosen to do this so it doesn't keep ovewriting the files.

# Jinja2 Template from https://vimeo.com/120005103
# Requires Jinja2 to be installed into python- http://jinja.pocoo.org/docs/dev/intro/
# Requires a Jinja2 template file to have already been created and variables set

# import librarys
import jinja2
import os

# Variables
from jinja_variables_template import *

# Setup jinja2
# tell jinja2 where to load templates from ( this should be your current working directory)
loader = jinja2.FileSystemLoader(os.getcwd())

#Create a jinja2 environment and reference the above loader
jenv = jinja2.Environment(loader=loader, trim_blocks=True, lstrip_blocks=True)

#Render the template based on jinja2 file name variable
template = jenv.get_template('template.jinja2')

#Render the configuration based on the variables then print the output
output = template.render(hardware_make=hardwareMake,hardware_model=hardwareModel,template_name=projectTemplateName,previous_template_name=previousTemplateName,jinja2_template_name=jinja2TemplateName, 
                         telco_name=telcoName,circuit_name=circuitName,bandwidth=bandwidth,routing=routing,connection_type=connectionType,customer_lans=customerLans,customer_static_routes=customerStaticRoutes,out_of_scope=outOfScope,
                         date_time=dateNow,engineer_name=engineerName,iface_lan_name=ifaceLanName,iface_wan_name=ifaceWanName)
#Write the configuration to file if the file does not already exist
if not os.path.exists(outputFileName):
    with open(outputFileName, 'wt') as f:
        f.write(output)
        print(output)
        print("\nTempate written to file: ",outputFileName)
else:
    print('n\Error: ',outputFileName,'already exists! Check and retry')

That's it. You should have everything you need to generate configuration files.
